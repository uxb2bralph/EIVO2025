@using System.IO
@using System.Linq.Expressions


@using ModelCore.Helper
@using ModelCore.Locale
@using ModelCore.DataEntity
@using WebHome.Controllers
@using WebHome.Helper
@using ModelCore.Models.ViewModel
@using WebHome.Models.ViewModel
@using ModelCore.DataExchange
@using CommonLib.Core.Utility
@using CommonLib.Utility
@using Microsoft.AspNetCore.Mvc.ModelBinding
@using Microsoft.AspNetCore.Mvc.Razor
@using Microsoft.AspNetCore.Mvc

@{
    Layout = "~/Views/Shared/Module/MessageDialog.cshtml";
    ModelStateDictionary _modelState;
    ModelSource<InvoiceItem> models;

    _modelState = (ModelStateDictionary)ViewBag.ModelState;
    models = (ModelSource<InvoiceItem>)ViewContext.HttpContext.Items["Models"]!;
    InvoiceNoInterval _model = (InvoiceNoInterval)this.Model;
    InvoiceNoIntervalViewModel? _viewModel = ViewBag.ViewModel as InvoiceNoIntervalViewModel;

    _viewModel!.DialogID = $"dialog{DateTime.Now.Ticks}";
    var items = models.GetTable<InvoiceIssuerAgent>()
        .Where(a => a.AgentID == _model.SellerID)
        .Where(a => a.IssuerID != _model.SellerID)
        .Where(a => a.RelationType == (int)InvoiceIssuerAgent.RelationTypeEnum.MasterBranch);
}

<div class="border_gray">
    <label for="SellerID">請選擇分支機構營業人</label>
    <select name="SellerID" class="form-control">
        @foreach (var item in items.Select(i=>i.InvoiceIssuer).OrderBy(o=>o.ReceiptNo))
        {
            <option value="@item.CompanyID">@Html.Raw($"({item.ReceiptNo}){item.CompanyName}")</option>
        }
    </select>
</div>

<script>
    dialogButtons.push({
        text: "確定",
        icons: {
            primary: "ui-icon-close"
        },
        click: function () {
            var $formData = $('#@(_viewModel.DialogID)').find('input,select,textarea').serializeObject();
            $formData.KeyID = '@Html.Raw(_model.IntervalID.EncryptKey())';
            if (typeof $global.dialogCallback === 'function') {
                console.log($formData);
                $global.dialogCallback($formData);
            }
            $(this).dialog("close");
        }
    });

    //dialogButtons.push({
    //    text: "關閉",
    //    icons: {
    //        primary: "ui-icon-close"
    //    },
    //    click: function () {
    //        $(this).dialog("close");
    //    }
    //});
</script>



